# Syntropy Quant: Quant Trading Engine

## 📊 今天的模型优化工作（2024-12-28）

---

## 🌌 Syntropy Quant v5.0: Holographic Topological Field

### 核心创新
- **纤维丛理论**: 市场被建模为在基态（辛几何）和激发态（规范场）间跃迁的量子系统
- **贝里相位**: 拓扑不变量，测量流形的几何扭曲
- **Hurst 指数**: 分形维数，区分趋势（H>0.5）和均值回归（H<0.5）
- **朗道-金兹堡势**: 强制系统打破对称性，进入确定的相

### 架构组成
1. **Manifold Embedding**: 特征 → 相空间（q, p）
2. **双物理引擎**:
   - **Symplectic Euler**: 哈密顿动力学，能量守恒（Liouville定理），适用于稳定市场
   - **Yang-Mills Field**: 规范场，能量发散，适用于湍流市场
3. **几何观察者**: 计算最小作用路径
4. **Regime Gate**: 序参量，决定在辛几何和规范场之间的混合比例（0 = 稳定，1 = 混沌）
5. **策略头**: 混合专家，基于当前物理状态输出交易信号

### 训练发现
| 问题 | 现象 | 根因 | 解决方案 |
|------|--------|--------|----------|
| Regime全部判定为45% | 所有标的的regime都在模糊区间（0.3-0.7）| 训练目标不匹配 | 使用软希格斯势（降低惩罚权重），允许模型在叠加态中保持 |
| 期望收益但低胜率 | 平均9.0%收益，但胜率仅2.2%| 阈值设置过高 | 降低交易阈值，允许微弱信号也执行 |
| 高波动标表现差 | 湍流股（KO, WMT）表现不佳| Regime未正确识别 | 强制使用动态相对标签（基于Hurst的百分位数） |

### 模型参数
- **信号缩放**: 1.0（从4.5降低，避免极端仓位）
- **Higgs 势能权重**: 0.15（软对称性破缺，允许模型在"纠结"时保持叠加态，而不是为了避罚而强行装死）
- **熵正则化权重**: 1.0（强迫模型选择明确的regime（0或1））
- **自适应阈值**: 基于regime动态调整交易阈值（Gauge态0.02，Symplectic态0.05）

### 回测结果（合成数据）
| 标的 | 收益率 | Sharpe | 最大回撤 | Regime判定 | 分析 |
|--------|--------|--------|----------|-----------|
| NVDA | 26.4% | 1.05 | -9.5% | SYMPLECTIC | 模型未能识别NVDA的湍流特性，错误地使用了辛几何引擎 |
| QQQ | 19.7% | 1.29 | -3.1% | SYMPLECTIC | 湍势判定失效，ETF被当作震荡处理 |
| AAPL | 8.6% | 0.48 | -8.0% | SYMPLECTIC | 苹果股价未能激发Gauge场 |
| KO | 10.5% | 0.62 | -5.2% | SYMPLECTIC | 可口可乐被正确识别为稳定 |
| WMT | -13.6% | -1.44 | -13.6% | SYMPLECTIC | 沃尔玛特表现不佳，可能需要更长的lookback |

### 关键结论
✅ **拓扑场架构工作正常**: 双物理引擎、贝里相位、regime gate均正确运行
❌ **regime自适应失败**: 训练时没有给regime提供监督信号，导致regime gate学会了"保持中立"（~50%），从而导致"全员Symplectic"或"全员空仓"的死寂状态

---

## 🌋 Syntropy Quant v5.1: Criticality Injection

### 核心理论：朗道-金兹堡理论

在统计物理中，当系统温度接近临界点时，能量函数会形成两个对称的局部极小值（"真空态"和"磁有序态"），导致系统被困在中间，无法自发选择其中一个状态。

v5.0中的regime gate就遇到了这个问题：由于熵正则化的负号（鼓励远离0.5），模型学会了输出~0.5，从而导致"全员Symplectic"或"全员空仓"的死寂状态。

### 解决方案：朗道-金兹堡势能修正

\`\`\`python
# Loss函数中的朗道势能项
V(p) = 4 * p * (1-p)  # 双势阱：在p=0和p=1处有极小值（真空态），在p=0.5处有极大值（排斥态）
Loss_regime = torch.mean(p * (1-p))  # 排斥p=0.5的中间态
\`\`\`

### 三项外科手术式重构

#### 1. 显式连线
不再让模型去"猜"分形维数。我们将**Hurst指数直接硬连线到Regime Gate的输入端**，确保gate无法忽略拓扑信息。

#### 2. 双势阱机制
在Loss中引入朗道势能项，创造"排斥力"，强迫regime跌向0（完全辛几何）或1（完全规范场），**严禁**停留在0.5。

#### 3. 物理监督
不再只用利润来训练。我们预计算物理状态（Hurst > 0.55 = 混沌），并强迫模型以此为真理进行拟合。

### 训练改进

| 组件 | v5.0 | v5.1（优化后） | 改进效果 |
|--------|-------|---------------|--------------|
| Loss权重 | cls + 0.1*regime + 0.01*curvature | cls + 0.15*regime + 0.01*curvature | Higgs势能权重增加，允许模型先学会赚钱再学会物理 |
| Higgs权重 | 0.5（朗道势） | 0.15（软朗道势） | 降低权重，允许模型在不确定时保持叠加态 |
| Regime标签 | 隐式Hurst阈值 > 0.52 | 动态相对论标签（基于历史百分位数） | 强制每个市场周期内都有30%样本被标记为Gauge |
| 期望结果 | 模型学会在0-1间明确切换 | 模型学会区分symplectic和gauge状态 |

### 策略参数

| 物理状态 | 交易阈值 | 超导策略逻辑 |
|----------|----------|----------------|
| **Gauge (混沌/湍流)** | 0.02 | "只要有动量，立刻追击" |
| **Symplectic (稳定/震荡)** | 0.05 | "保持敏感，但要求更强的信号" |
| **不确定 (相变区间)** | 0.00 | "持有现金，等待信号" |

### 预期物理现象

#### v5.0（热寂）
\`\`\`python
Regime判定：所有标的~45%（全部在模糊区间）
策略：全员空仓或极低仓位
现象：对称性未破缺，系统处于局部极小值
\`\`\`

#### v5.1（临界态注入）
\`\`\`python
Regime判定：动量标的>Gauge，防御标的<Symplectic
策略：NVDA、TSLA等激进追涨（阈值0.02），KO、JNJ等稳健震荡（阈值0.05）
现象：对称性破缺，系统进入确定的相
预期：NVDA应在Gauge态下获得>20%收益，KO应在Symplectic态下获得稳健收益
\`\`\`

### 理论优势

1. **拓扑不变量守恒**: 贝里相位正确计算流形的几何扭转
2. **辛几何能量守恒**: Liouville定理确保相空间体积守恒
3. **规范场能量发散**: Yang-Mills场模拟能量注入和趋势形成
4. **朗道-金兹堡相变**: 在临界温度下强制系统进入有序相，打破"真空态"

### 关键指标监控

在训练时重点监控：
- **Gauge State比例**: 目标30%-40%（允许在混沌市场和稳定市场间切换）
- **Higgs势能**: 确保Loss_regime贡献合理，不压抑模型的适应能力
- **Polarization指数**: \`\`\`python
mean(|regime - 0.5| > 0.3)\`\`\`python，如果接近1说明模型开始明确选择

---

## 🔧 实现细节

### 特征工程（v5.1）
\`\`\`python
# 动态相对论标签
chaos_score = hurst + (trend * 10)  # 分形 + 趋势
threshold = np.percentile(chaos_score, 70)  # 70th百分位数
regime_label = np.zeros_like(hurst)
regime_label[chaos_score > threshold] = 1.0  # 强制Gauge Regime
\`\`\`

### 混合内核（v5.1）
\`\`\`python
# 显式连线
gate_input = torch.cat([latent_state, hurst], dim=-1)  # 将Hurst直接连到gate输入

# 朗道-金兹堡势能（在loss函数中计算）
p = output['regime_prob']
loss_higgs = 0.15 * torch.mean(p * (1.0 - p))  # 软朗道势，排斥p=0.5
\`\`\`

### 回测策略（v5.1）
\`\`\`python
# 超导阈值（打破零交易死寂状态）
if r > 0.5:  # Gauge态
    if s > 0.02: position = 1.0  # 超低门槛，只要有动量就交易
elif r < 0.4:  # Symplectic态
    if s > 0.05: position = 0.8  # 保守但活跃
else:  # 不确定
    position = 0.0  # 现金
\`\`\`

---

## 📊 性能指标对比

| 版本 | 核心概念 | 创新点 | 状态 | 训练样本 | 参数量 | 平均收益 | Sharpe | 胜率 | 平均Regime |
|------|----------|--------|--------|--------|--------|----------|----------|----------|
| v5.0 | 全息拓扑场 | 纤维数、贝里相位、regime gate | ❌ Regime识别失败（45%徘徊） | ~5,000 | 16,068 | 9.0% | 0.61 | 2.2% | 45.6%（混沌判定，失败） |
| v5.1 | 临界态注入 | 朗道-金兹堡理论、双势阱、动态相对标签 | 🔄 待执行 | ~15,000 | 16,500 | 预期15%-20% | 预期1.0-1.5 | 预期10%+ | 预期35%（明确区分） |

---

## 🎯 结论

v5.0的"全息拓扑场"概念在数学上是先进的，但**当前的实现未能突破临界点**——系统处于过冷状态，regime gate学会了"保持中立"（45%徘徊），从而导致"全员Symplectic"或"全员空仓"的死寂状态。

v5.1通过引入**朗道-金兹堡临界态注入**，预期将系统推入超流体状态，打破对称性，让regime gate学会明确的物理状态选择，从而释放全息拓扑场的真正威力。

---

**最后更新**: 2024-12-28
**状态**: v5.0已构建，v5.1设计完成，等待执行训练
**下一步**: 使用Tiingo + Polygon API获取真实市场数据，训练50个epochs，验证regime gate是否学会明确切换

---
